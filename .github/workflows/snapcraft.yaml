name: Build & Publish Snap

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish:
        description: 'Set to "yes" to actually publish to the Snap Store'
        required: false
        default: 'no'
      channel:
        description: 'Release channel to use when publishing (edge/beta/stable)'
        required: false
        default: 'edge'

jobs:
  build-and-publish:
    name: ðŸ§ª Build and (optionally) publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse snapcraft.yaml
        id: parse
        uses: snapcrafters/ci/parse-snapcraft-yaml@main
        with:
          snapcraft-project-root: 'snap'

      - name: Test snap build (smoke test)
        uses: snapcrafters/ci/test-snap-build@main
        with:
          snapcraft-project-root: 'snap'
          install: 'false'

      - name: Ensure snapcraft is installed
        run: |
          if ! command -v snapcraft >/dev/null 2>&1; then
            sudo snap install snapcraft --classic || true
          fi

      - name: Locate built snap
        id: find-snap
        run: |
          set -e
          # search for a .snap produced by snapcraft under the snap/ directory
          SNAP=$(find snap -maxdepth 4 -name '*.snap' -print | head -n1 || true)
          if [ -z "$SNAP" ]; then
            echo "no_snap_found=true" >> $GITHUB_OUTPUT
          else
            SNAP_REL=$(realpath --relative-to="$GITHUB_WORKSPACE" "$SNAP")
            echo "snapfile=$SNAP_REL" >> $GITHUB_OUTPUT
          fi

      - name: Publish to Snap Store
        if: |
          startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'yes') || github.event_name == 'release'
        env:
          CHANNEL: ${{ github.event.inputs.channel || 'edge' }}
          # Set the store credentials from the repository secret so snapcraft can use them
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_LOGIN }}
        run: |
          CHANNEL=${CHANNEL:-edge}
          SNAPFILE=${{ steps.find-snap.outputs.snapfile }}
          if [ -z "$SNAPFILE" ]; then
            echo "No .snap artifact found to publish"; exit 1
          fi
          # If this is a manual publish request and the credentials secret is empty, fail early
          if [ "${{ github.event_name }}" = 'workflow_dispatch' ] && [ "${{ github.event.inputs.publish }}" != 'yes' ]; then
            echo "Manual run without publish=yes; skipping publish"; exit 0
          fi
          if [ -z "${SNAPCRAFT_STORE_CREDENTIALS}" ]; then
            echo "SNAPCRAFT_STORE_CREDENTIALS secret is empty; cannot authenticate to Snap Store"; exit 1
          fi
          echo "Publishing $SNAPFILE to channel $CHANNEL"
          # snapcraft now prefers 'upload' over 'push'
          snapcraft upload "$SNAPFILE" --release="$CHANNEL"

